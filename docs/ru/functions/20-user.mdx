---
weight: 20
sourceSHA: 3b247baa29686c88b99f33d793fbdbda197becc56eeb06a248e7c5459aafc402
---

# Управление пользователями

Правильная аутентификация и контроль доступа крайне важны для обеспечения безопасности вашей среды Redis. Этот раздел охватывает управление паролями и конфигурацию управления доступом на основе ролей для экземпляров Redis.

<Directive type="info" title="Примечание о совместимости версий">
  Redis 5.0 поддерживает только базовую аутентификацию паролем с одним набором учетных данных, в то время как Redis 6.0 и более поздние версии реализуют комплексную систему списка управления доступом (ACL), которая поддерживает множество пользователей с детальными разрешениями. Redis 6.0 и более поздние версии сохраняют пользователя по умолчанию для обратной совместимости с устаревшими клиентами.
</Directive>

## Просмотр пользователей

Следующие методы позволяют просматривать всех пользователей, связанных с экземпляром Redis.

<Tabs>
  <Tab label="CLI">
    Экземпляры Redis (версии 6.0+) используют специальные ресурсы `RedisUser` (CR) для управления учетными записями пользователей. Чтобы перечислить всех пользователей, связанных с определенным экземпляром:

    ```bash
    $ kubectl -n default get redisuser -l middleware.instance/name=<instance_name>
    ```

    Например, для того, чтобы перечислить всех пользователей для экземпляра с именем `s6`:

    ```bash
    $ kubectl -n test get redisuser -l middleware.instance/name=s6
    NAME                  INSTANCE   USERNAME   PHASE     AGE
    rfr-acl-s6-admin      s6         admin      Success   22s
    rfr-acl-s6-app-a      s6         app-a      Success   45s
    rfr-acl-s6-app-b      s6         app-b      Success   6s
    rfr-acl-s6-default    s6         default    Success   3m17s
    rfr-acl-s6-operator   s6         operator   Success   3m17s
    ```

    Полевые данные предоставляют следующую информацию:

    | Поле    | Описание                                                                                                                                                                                                                   |
    | :------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
    | NAME     | Идентификатор пользовательского ресурса RedisUser                                                                                                                                                                          |
    | INSTANCE | Имя связанного экземпляра Redis                                                                                                                                                                                          |
    | USERNAME | Имя пользователя, зарегистрированное в Redis                                                                                                                                                                            |
    | PHASE    | Статус синхронизации: <ul><li>`Success`: Конфигурация пользователя успешно синхронизирована со всеми узлами Redis</li><li>`Fail`: Синхронизация пользователя не удалась на одном или нескольких узлах Redis</li><li>`Pending`: Связанный экземпляр Redis не готов или синхронизация в процессе</li></ul> |

    <Directive type="warning" title="Учетная запись системного оператора">
      Каждый экземпляр Redis включает встроенного пользователя **оператора**, который автоматически создается во время создания экземпляра. Эта учетная запись системы имеет обширные разрешения (включая возможности управления пользователями) и защищена сложным паролем длиной 64 символа.

      Эта учетная запись предназначена исключительно для системных операций и никогда не должна использоваться для доступа к приложениям. Любые изменения в конфигурации этой учетной записи могут вызвать серьезную нестабильность экземпляра и потенциально привести к состояниям сбоя, которые невозможно восстановить.
    </Directive>
  </Tab>

  <Tab label="Веб-консоль">
    1. Перейдите в **Redis** в левой панели навигации.
    2. Выберите ***имя пространства имен***, содержащее ваш экземпляр.
    3. Щелкните по ***имени экземпляра***, чтобы получить доступ к его деталям.
    4. Откройте вкладку **Управление пользователями**, чтобы просмотреть исчерпывающий список всех пользователей, настроенных для экземпляра.
  </Tab>
</Tabs>

## Обновление пароля

Следующие процедуры позволяют обновлять пароли пользователей для повышения безопасности. Регулярная смена паролей рекомендуется как лучшая практика безопасности.

### Процедура

<Tabs>
  <Tab label="CLI">
    <Directive type="info" title="Совместимость версий">
      Следующие операции применимы только к версиям Redis 6.0 и выше. Для Redis 5.0 смотрите вкладку "Redis 5.0 CLI".
    </Directive>

    1. Определите целевого пользователя из списка RedisUser.

       В этом примере мы обновим пароль для пользователя `default` экземпляра `s6`.

    2. Получите ресурс RedisUser, чтобы определить связанный пароль Secret:

    ```bash
    $ kubectl -n default get RedisUser rfr-acl-s6-default -o yaml
    apiVersion: redis.middleware.alauda.io/v1
    kind: RedisUser
    metadata:
      annotations:
        middleware.alauda.io/acl-supported-version: "6.0"
      creationTimestamp: "2025-02-28T02:07:26Z"
      finalizers:
      - redisusers.redis.middleware.alauda.io/finalizer
      generation: 1
      labels:
        managed-by: redis-operator
        middleware.instance/name: s6
      name: rfr-acl-s6-default
      namespace: default
      ownerReferences:
      - apiVersion: databases.spotahome.com/v1
        blockOwnerDeletion: true
        controller: true
        kind: RedisFailover
        name: s6
        uid: 56596fa0-4a42-408b-ba26-d61b3a42b60c
      - apiVersion: middleware.alauda.io/v1
        blockOwnerDeletion: true
        kind: Redis
        name: s6
        uid: 80d2e7b0-02d2-490f-bec4-f145f2c738fc
      resourceVersion: "1014064"
      uid: aae888f3-86ba-48bd-9376-710070bf07e0
    spec:
      accountType: default
      aclRules: +@all -acl -flushall -flushdb -keys ~*
      arch: sentinel
      passwordSecrets:
      - redis-s6-2hqxb
      redisName: s6
      username: default
    status:
      Phase: Success
      lastUpdateSuccess: "2025-02-28T02:16:28Z"
    ```

    Из поля `spec.passwordSecrets[0]` мы можем увидеть, что пароль хранится в секретном файле `redis-s6-2hqxb`.

    3. Проверьте текущий секрет пароля:

    ```bash
    $ kubectl -n default get secret redis-s6-2hqxb -o yaml
    apiVersion: v1
    data:
      password: YWRtaW5AMTIz
    kind: Secret
    metadata:
      annotations:
        cpaas.io/creator: admin
        cpaas.io/operator: admin
        cpaas.io/updated-at: "2025-02-28T08:49:38Z"
      creationTimestamp: "2025-02-28T02:07:24Z"
      generateName: redis-s6-
      labels:
        managed-by: redis-operator
        middleware.instance/name: s6
      name: redis-s6-2hqxb
      namespace: default
      ownerReferences:
      - apiVersion: redis.middleware.alauda.io/v1
        blockOwnerDeletion: true
        controller: true
        kind: RedisUser
        name: rfr-acl-s6-default
        uid: aae888f3-86ba-48bd-9376-710070bf07e0
      resourceVersion: "1183397"
      uid: 45a5faa7-5b47-4a6a-a4e4-c614feccb806
    type: Opaque
    ```

    > Примечание: Ключ `password` является зарезервированным именем поля, используемым Redis Operator. Его значение хранится в виде строкового значения, закодированного в base64.

    4. Обновите секрет с новым паролем:

    ```bash
    $ kubectl -n default patch secret redis-s6-2hqxb --type=merge --patch='{"stringData": {"password": "admin@12345"}}'
    ```

    5. Проверьте обновление пароля:

    ```bash
    $ kubectl -n default get secret redis-s6-2hqxb -o jsonpath='{.data.password}' | base64 -d
    admin@12345
    ```

    После обновления пароля ресурс RedisUser временно перейдет в состояние `Pending`, пока изменения не распространятся по всем узлам Redis. После синхронизации статус вернется в `Success`.
  </Tab>

  <Tab label="Redis 5.0 CLI">
    Redis 5.0 не поддерживает систему ACL и, следовательно, не использует ресурсы RedisUser. Вместо этого пароль управляется через поле `spec.passwordSecret` в CR Redis (см. [Документация по API Redis](../apis/kubernetes_apis/redis/redis)).

    <Directive type="warning" title="Предупреждение о влиянии на сервис">
      Обновление пароля для экземпляра Redis 5.0 требует полной перезагрузки экземпляра, что может вызвать прерывание сервиса. Запланируйте эту операцию на время обслуживания или периоды низкой нагрузки.
    </Directive>

    1. Создайте секрет, содержащий новый пароль:

    ```bash
    $ kubectl -n default create secret generic new-redis-password --from-literal=password=admin@123456
    ```

    2. Обновите CR Redis, чтобы сослаться на новый секрет:

    ```bash
    $ kubectl -n default patch redis s5 --type=merge --patch='{"spec": {"passwordSecret": "new-redis-password"}}'
    ```

    3. Мониторьте статус экземпляра во время процесса обновления:

    ```bash
    $ kubectl -n default get redis -w
    NAME ARCH       VERSION   ACCESS     STATUS         MESSAGE   BUNDLE VERSION   AUTOUPGRADE   AGE
    c6   cluster    6.0                  Ready                    4.0.1            false         125m
    s5   sentinel   5.0                  Initializing             4.0.1            false         8h
    s6   sentinel   6.0                  Ready                    4.0.1            false         124m
    ```

    Экземпляр перейдет в состояние `Ready`, как только изменение пароля будет завершено.
  </Tab>

  <Tab label="Веб-консоль">
    1. На вкладке **Управление пользователями** выберите целевого пользователя и нажмите кнопку развертывания, чтобы просмотреть детали пользователя.
    2. Нажмите **Сброс пароля** в меню действий.
    3. Введите новый пароль и подтвердите, введя его снова.
    4. Нажмите **Обновить** и дождитесь завершения процесса синхронизации.
  </Tab>
</Tabs>

## Обновление разрешений

Redis 6.0+ поддерживает контроль доступа на основе детализированных разрешений через свою систему ACL. Платформа предоставляет заранее определенные профили разрешений для распространенных случаев использования:

| Профиль разрешений | Правила ACL                             | Описание                                                                                         |
| :----------------- | :-------------------------------------- | :------------------------------------------------------------------------------------------------ |
| NotDangerous       | `+@all -@dangerous ~*`                  | Предоставляет доступ ко всем командам на всех ключах, за исключением тех, которые классифицируются как потенциально опасные операции |
| ReadWrite          | `-@all +@write +@read -@dangerous ~*`   | Разрешает операции чтения и записи на всех ключах при блокировке опасных команд                    |
| ReadOnly           | `-@all +@read -keys ~*`                 | Ограничивает доступ только к операциям чтения на всех ключах                                      |
| Администратор      | `+@all -acl ~*`                         | Предоставляет полный доступ ко всем функциям Redis, за исключением команд управления ACL          |

Для более сложных случаев использования поддерживаются пользовательские правила ACL. Обратитесь к [Документации по ACL Redis](https://redis.io/topics/acl) для получения подробного синтаксиса и возможностей.

> Примечание: Все профили разрешений, включая пользовательские, явно отзывают разрешения на управление ACL. Изменения пользователей должны выполняться через интерфейсы управления пользователями платформы.

### Процедура

<Tabs>
  <Tab label="CLI">
    ```bash
    $ kubectl -n default patch RedisUser s56 --type=merge --patch='{"spec": {"aclRules": "+@all ~*"}}'
    ```

    После успешного создания пользователь случайным образом переходит в состояние `Pending`. Дождитесь изменения его на `Success`, что указывает на то, что обновление прошло успешно.
  </Tab>

  <Tab label="Веб-консоль">
    1. Выберите соответствующую информацию о пользователе и нажмите кнопку развертывания.

    2. Выберите **Обновить разрешения**.

    3. Выберите набор разрешений или нажмите "пользовательский", чтобы ввести собственные правила.

    4. Нажмите **Обновить** и дождитесь завершения обновления.
  </Tab>
</Tabs>

## Создание пользователя

### Процедура

<Tabs>
  <Tab label="CLI">
    Создание для экземпляра кластера Redis.

    ```bash
    $ cat << EOF | kubectl -n default create -f -
    apiVersion: redis.middleware.alauda.io/v1
    kind: RedisUser
    metadata:
      name: rfr-acl-s6-app-a
    spec:
      accountType: custom
      aclRules: +@all -acl ~*
      passwordSecrets:
      - new-redis-password
      redisName: s6
      username: app-a
    EOF

    Как только статус ресурса изменится на `Success`, вы сможете подключиться с новым паролем для отладки.
    ```
  </Tab>

  <Tab label="Веб-консоль">
    1. Нажмите **Создать пользователя**.

    2. Введите имя пользователя.

    3. Введите пароль и повторите его для подтверждения.

    4. Выберите набор разрешений или нажмите "пользовательский", чтобы ввести собственные правила.

    5. Нажмите **Подтвердить**, чтобы создать пользователя.

    6. Выберите пользователя, и вы сможете проверить статус пользователя, щелкнув по имени пользователя.

    Как только статус ресурса изменится на **Нормальный**, вы сможете подключиться с новым паролем для отладки.
  </Tab>
</Tabs>
