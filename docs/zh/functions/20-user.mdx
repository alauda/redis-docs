---
weight: 20
---

# 用户管理

为确保 Redis 环境安全，请务必设置密码，并妥善保管您的密码。若发现有泄漏风险，请及时更新密码。对于不用业务的使用，可创建不同的用户实现用户权限分离，提高安全性。

<Directive type="info" title="提示">
Redis 5 只支持单一密码验证，不支持自定义用户。Redis 从 6.0 开始才支持 ACL，同时内置一个 default 用户用于兼容老版本客户端。
</Directive>

## 查看用户

查看实例关联的所有用户。

<Tabs>

<Tab label="CLI">

实例用户关联的 CR 资源类型为 `RedisUser`，可通过如下命令来查看实例关联的所有用户：

> 只针对非 Redis 5.0 实例

```bash
kubectl -n default get redisuser -l middleware.instance/name=<实例名称>
```

示例获取实例 `s6` 的用户信息如下：

```bash
$ kubectl -n test get redisuser -l middleware.instance/name=s6
NAME                  INSTANCE   USERNAME   PHASE     AGE
rfr-acl-s6-admin      s6         admin      Success   22s
rfr-acl-s6-app-a      s6         app-a      Success   45s
rfr-acl-s6-app-b      s6         app-b      Success   6s
rfr-acl-s6-default    s6         default    Success   3m17s
rfr-acl-s6-operator   s6         operator   Success   3m17s
```

输出结果的字段说明如下：

| 字段          | 说明                                   |
|:--------------|:---------------------------------------|
| NAME          | RedisUser CR 资源的名称                |
| INSTANCE      | RedisUser CR 资源关联的 Redis 实例名称 |
| USERNAME      | Redis 中注册的 Redis 名称              |
| PHASE         | RedisUser CR 资源状态，包括 <ul><li>`Success`: 用户同步到所有 Redis 节点成功</li><li>`Fail`: 用户同步到所有 Redis 节点失败</li><li>`Pending`: 关联的 Redis 实例未就绪</li></ul>  |

<Directive type="warning" title="operator 账户说明">
实例内置了一个 **operator** 用户用于构建集群，该用户会在实例创建时自动创建。该用户拥有实例的所有权限(包括创建新用户的权限)，同时拥有一个64位的复杂密码。

该账户只能供 operator 自身使用，不可用于业务；不可更新或修改该账户任何信息，修改该账户的信息会导致实例异常且不可恢复。
</Directive>

</Tab>

<Tab label='Web Console'>
1. 在左侧导航栏中，单击 **Redis**。

2. 单击 ***命名空间的名称***。

3. 单击 ***实例的名称***。

4. 可在实例的 **用户管理** 页签中查看管理该实例的所有用户信息。
</Tab>

</Tabs>

## 更新密码

### 操作步骤

<Tabs>

<Tab label="CLI">

<Directive type="info" title="提示">
以下操作只针对 Redis >= 6.0 的实例。
</Directive>

1. 从列表中找到要更新的用户

  这里假设要更新实例 s6 的 `default` 用户的密码。

2. 获取用户关联的 secret 资源

```bash
$ kubectl -n default get RedisUser rfr-acl-s6-default -o yaml
apiVersion: redis.middleware.alauda.io/v1
kind: RedisUser
metadata:
  annotations:
    middleware.alauda.io/acl-supported-version: "6.0"
  creationTimestamp: "2025-02-28T02:07:26Z"
  finalizers:
  - redisusers.redis.middleware.alauda.io/finalizer
  generation: 1
  labels:
    managed-by: redis-operator
    middleware.instance/name: s6
  name: rfr-acl-s6-default
  namespace: hfxia-dev
  ownerReferences:
  - apiVersion: databases.spotahome.com/v1
    blockOwnerDeletion: true
    controller: true
    kind: RedisFailover
    name: s6
    uid: 56596fa0-4a42-408b-ba26-d61b3a42b60c
  - apiVersion: middleware.alauda.io/v1
    blockOwnerDeletion: true
    kind: Redis
    name: s6
    uid: 80d2e7b0-02d2-490f-bec4-f145f2c738fc
  resourceVersion: "1014064"
  uid: aae888f3-86ba-48bd-9376-710070bf07e0
spec:
  accountType: default
  aclRules: +@all -acl -flushall -flushdb -keys ~*
  arch: sentinel
  passwordSecrets:
  - redis-s6-2hqxb
  redisName: s6
  username: default
status:
  Phase: Success
  lastUpdateSuccess: "2025-02-28T02:16:28Z"
```

各字段的说明，参考 [RedisUser API](../apis/kubernetes_apis/redis/redisuser)。

从字段 `spec.passwordSecrets[0]`获取到`default`用户的密码存储在`redis-s6-2hqxb`这个 Secret 中。

```bash
$ kubectl -n default get secret redis-s6-2hqxb -o yaml
apiVersion: v1
data:
  password: YWRtaW5AMTIz
kind: Secret
metadata:
  annotations:
    cpaas.io/creator: admin
    cpaas.io/operator: admin
    cpaas.io/updated-at: "2025-02-28T08:49:38Z"
  creationTimestamp: "2025-02-28T02:07:24Z"
  generateName: redis-s6-
  labels:
    managed-by: redis-operator
    middleware.instance/name: s6
  name: redis-s6-2hqxb
  namespace: hfxia-dev
  ownerReferences:
  - apiVersion: redis.middleware.alauda.io/v1
    blockOwnerDeletion: true
    controller: true
    kind: RedisUser
    name: rfr-acl-s6-default
    uid: aae888f3-86ba-48bd-9376-710070bf07e0
  resourceVersion: "1183397"
  uid: 45a5faa7-5b47-4a6a-a4e4-c614feccb806
type: Opaque
```

> 输出的信息中，`password`固定字段名，operator 中使用了该字段，不可变更。其值是一个 base64 编码的密文。

通过如下命令直接更新`password` 为新密码：

```bash
$ kubectl -n default patch secret redis-s6-2hqxb --type=merge --patch='{"stringData": {"password": "admin@12345"}}'
```

可通过如下命令确认密码更新成功：

```bash
$ kubectl -n default get secret redis-s6-2hqxb -o jsonpath='{.data.password}' | base64 -d
admin@12345
```

在更新密码之后，RedisUser 实例会进入 `Pending` 状态。待更新完成，

</Tab>


<Tab label="Redis 5.0 CLI">

Redis 5 不支持 ACL，也就没有 RedisUser 资源来管理 Redis 的用户。针对 Redis 实例，有字段 `spec.passwordSecret` 来记录当前实例的密码(具体文档参考：[Redis API 文档](../apis/kubernetes_apis/redis/redis))。

<Directive type="warning" title="警告">
对更新密码会导致实例重启，业务会出现闪断现象，建议您避开业务敏感时期进行操作。
</Directive>

1. 创建保存了新密码的 Secret

```bash
kubectl -n default create secret generic new-redis-password --from-literal=password=admin@123456
```

2. 将新 Secret 更新到实例的 `spec.passwordSecret` 字段

```bash
kubectl -n default patch redis s5 --type=merge --patch='{"spec": {"passwordSecret": "new-redis-password"}}'
```

执行之后，实例的状态变成 `Initializing`，可通过一下名称查看：

```
$ kubectl -n default get redis -w
NAME ARCH       VERSION   ACCESS     STATUS         MESSAGE   BUNDLE VERSION   AUTOUPGRADE   AGE
c6   cluster    6.0                  Ready                    3.18.19          false         125m
s5   sentinel   5.0                  Initializing             3.18.19          false         8h
s6   sentinel   6.0                  Ready                    3.18.19          false         124m
```

</Tab>

<Tab label="Web Console">

1. 选择对应用户信息，点击扩展按钮。

2. 选择 **重置密码** ，输入密码，二次输入以确认密码。

3. 等待更新完成即可。

</Tab>

</Tabs>

## 更新权限

Web Console 提供了如下预定义权限集：

| 权限集       | ACL 规则                            | 描述                                                        |
|:-------------|:------------------------------------|:------------------------------------------------------------|
| NotDangerous | +@all -@dangerous ~*                | 允许对所有 KEY 使用除 dangerous 类之外的所有命令。          |
| ReadWrite    | -@all +@write +@read -@dangerous ~* | 允许对所有键使用除 dangerous 类别之外的所有读取和写入命令。 |
| ReadOnly     | -@all +@read -keys ~*               | 允许对所有 KEY 使用 read 类中的所有命令。                   |
| Administator | +@all -acl ~*                       | 允许对所有 KEY 使用所有命令。                               |

此外，还支持自定义规则。对于自定义规则，您可以参考 Redis 社区文档 [ACL 规则](https://redis.io/topics/acl)。

> 需要注意的是，不管是内置 ACL 规则，还是自定义规则，都强制回收了执行 ACL 命令的权限。需要变更用户，只能在这里进行操作。

### 操作步骤

<Tabs>

<Tab label="CLI">

```bash
kubectl -n default patch RedisUser s56--type=merge --patch='{"spec": {"aclRules": "+@all ~*"}}'
```

在创建成功之后，该用户随机进入 `Pending` 状态。等待其变成 `Success` 状态，即表示更新成功。

</Tab>

<Tab label="Web Console">

1. 选择对应用户信息，点击扩展按钮。

2. 选择 **更新权限** 点击。

3. 选择权限集或者点击自定义输入自定义规则。

4. 点击 **更新**，等待更新完成。

</Tab>

</Tabs>

## 创建用户

### 操作步骤

<Tabs>

<Tab label="CLI">

给Redis 集群实例创建

```bash
cat << EOF | kubectl -n default create -f -
apiVersion: redis.middleware.alauda.io/v1
kind: RedisUser
metadata:
  name: rfr-acl-s6-app-a
spec:
  accountType: custom
  aclRules: +@all -acl ~*
  passwordSecrets:
  - new-redis-password
  redisName: s6
  username: app-a
EOF

资源状态变为 `Success` 后，即可使用新密码进行连接调试。
```
</Tab>

<Tab label="Web Console">

1. 点击 **创建用户**。

2. 输入用户名。

3. 输入密码，和重复输入确认密码。

4. 选择权限集或点击自定义输入自定义规则。

5. 点击 **确认**，创建用户。

6. 选择用户，点击用户名可以查看用户状态。

资源状态变为 **正常** 后，即可使用新密码进行连接调试。
</Tab>

</Tabs>
