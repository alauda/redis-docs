---
weight: 20
sourceSHA: 7ecda9569433f070ad4a86ab5e07448a3376e3e85a7009ffe69b4c3347d39405
---

# 用户管理

为确保 Redis 环境的安全性，务必设置密码并妥善保管。如果存在泄漏风险，请及时更新密码。在不使用的业务场景下，可以创建不同的用户以实现权限分离，从而提升安全性。

<Directive type="info" title="提示">
  Redis 5 仅支持单一密码验证，并且不支持自定义用户。Redis 6.0 及以后的版本引入了 ACL 支持，并包含一个默认用户以兼容旧版本客户端。
</Directive>

## 查看用户

查看与实例关联的所有用户。

<Tabs>
  <Tab label="CLI">
    实例用户关联的 CR 资源类型为 `RedisUser`。您可以使用以下命令查看与实例关联的所有用户：

    > 仅适用于非 Redis 5.0 实例。

    ```bash
    $ kubectl -n default get redisuser -l middleware.instance/name=<实例名称>
    ```

    检索实例 `s6` 的用户信息示例如下：

    ```bash
    $ kubectl -n test get redisuser -l middleware.instance/name=s6
    NAME                  INSTANCE   USERNAME   PHASE     AGE
    rfr-acl-s6-admin      s6         admin      Success   22s
    rfr-acl-s6-app-a      s6         app-a      Success   45s
    rfr-acl-s6-app-b      s6         app-b      Success   6s
    rfr-acl-s6-default    s6         default    Success   3m17s
    rfr-acl-s6-operator   s6         operator   Success   3m17s
    ```

    输出字段的说明如下：

    | 字段    | 说明                                                                                                                                                                                                                                                     |
    | :------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | NAME     | RedisUser CR 资源的名称                                                                                                                                                                                                                           |
    | INSTANCE | 与 RedisUser CR 资源关联的 Redis 实例的名称                                                                                                                                                                                        |
    | USERNAME | 在 Redis 中注册的用户名                                                                                                                                                                                                                              |
    | PHASE    | RedisUser CR 资源的状态，包括 <ul><li>`Success`: 用户成功同步到所有 Redis 节点</li><li>`Fail`: 用户在所有 Redis 节点同步失败</li><li>`Pending`: 关联的 Redis 实例尚未就绪</li></ul> |

    <Directive type="warning" title="operator 账户说明">
      一个 **operator** 用户内置于实例中用于集群构建，此用户在实例创建时自动创建。该用户拥有实例的所有权限（包括创建新用户的权限），并设置有复杂的 64 位密码。

      此账户仅供 operator 自身使用，不可用于业务用途；该账户的任何信息都无法更新或修改，修改任何信息将导致实例故障且无法恢复。
    </Directive>
  </Tab>

  <Tab label="Web Console">
    1. 单击左侧导航栏中的 **Redis**。
    2. 单击 ***命名空间名称***。
    3. 单击 ***实例名称***。
    4. 您可以在实例的 **用户管理** 页签中查看所有管理此实例的用户信息。
  </Tab>
</Tabs>

## 更新密码

### 操作步骤

<Tabs>
  <Tab label="CLI">
    <Directive type="info" title="提示">
      以下操作仅适用于 Redis 6.0 或更高版本。
    </Directive>

    1. 从列表中找到要更新的用户。

      假设我们要更新实例 `s6` 的 `default` 用户密码。

    2. 获取与用户关联的 secret 资源。

    ```bash
    $ kubectl -n default get RedisUser rfr-acl-s6-default -o yaml
    apiVersion: redis.middleware.alauda.io/v1
    kind: RedisUser
    metadata:
      annotations:
        middleware.alauda.io/acl-supported-version: "6.0"
      creationTimestamp: "2025-02-28T02:07:26Z"
      finalizers:
      - redisusers.redis.middleware.alauda.io/finalizer
      generation: 1
      labels:
        managed-by: redis-operator
        middleware.instance/name: s6
      name: rfr-acl-s6-default
      namespace: hfxia-dev
      ownerReferences:
      - apiVersion: databases.spotahome.com/v1
        blockOwnerDeletion: true
        controller: true
        kind: RedisFailover
        name: s6
        uid: 56596fa0-4a42-408b-ba26-d61b3a42b60c
      - apiVersion: middleware.alauda.io/v1
        blockOwnerDeletion: true
        kind: Redis
        name: s6
        uid: 80d2e7b0-02d2-490f-bec4-f145f2c738fc
      resourceVersion: "1014064"
      uid: aae888f3-86ba-48bd-9376-710070bf07e0
    spec:
      accountType: default
      aclRules: +@all -acl -flushall -flushdb -keys ~*
      arch: sentinel
      passwordSecrets:
      - redis-s6-2hqxb
      redisName: s6
      username: default
    status:
      Phase: Success
      lastUpdateSuccess: "2025-02-28T02:16:28Z"
    ```

    各字段的详细说明可以在 [RedisUser API](../apis/kubernetes_apis/redis/redisuser) 中找到。

    从字段 `spec.passwordSecrets[0]` 得知 `default` 用户的密码存储在 Secret `redis-s6-2hqxb` 中。

    ```bash
    $ kubectl -n default get secret redis-s6-2hqxb -o yaml
    apiVersion: v1
    data:
      password: YWRtaW5AMTIz
    kind: Secret
    metadata:
      annotations:
        cpaas.io/creator: admin
        cpaas.io/operator: admin
        cpaas.io/updated-at: "2025-02-28T08:49:38Z"
      creationTimestamp: "2025-02-28T02:07:24Z"
      generateName: redis-s6-
      labels:
        managed-by: redis-operator
        middleware.instance/name: s6
      name: redis-s6-2hqxb
      namespace: hfxia-dev
      ownerReferences:
      - apiVersion: redis.middleware.alauda.io/v1
        blockOwnerDeletion: true
        controller: true
        kind: RedisUser
        name: rfr-acl-s6-default
        uid: aae888f3-86ba-48bd-9376-710070bf07e0
      resourceVersion: "1183397"
      uid: 45a5faa7-5b47-4a6a-a4e4-c614feccb806
    type: Opaque
    ```

    > 输出信息中，`password` 是一个固定字段名，由 operator 使用，不可更改。其值为 Base64 编码的密文。

    使用以下命令更新 `password` 为新密码：

    ```bash
    $ kubectl -n default patch secret redis-s6-2hqxb --type=merge --patch='{"stringData": {"password": "admin@12345"}}'
    ```

    使用以下命令确认密码更新成功：

    ```bash
    $ kubectl -n default get secret redis-s6-2hqxb -o jsonpath='{.data.password}' | base64 -d
    admin@12345
    ```

    更新密码后，RedisUser 实例将进入 `Pending` 状态。待更新完成，
  </Tab>

  <Tab label="Redis 5.0 CLI">
    Redis 5 不支持 ACL，因此没有 RedisUser 资源来管理 Redis 用户。对于 Redis 实例，有字段 `spec.passwordSecret` 用于记录当前实例的密码（具体文档参考：[Redis API 文档](../apis/kubernetes_apis/redis/redis)）。

    <Directive type="warning" title="警告">
      更新密码将导致实例重启，可能会造成服务中断。建议避免在业务敏感期执行此操作。
    </Directive>

    1. 创建保存新密码的 Secret。

    ```bash
    $ kubectl -n default create secret generic new-redis-password --from-literal=password=admin@123456
    ```

    2. 将新 Secret 更新到实例的 `spec.passwordSecret` 字段。

    ```bash
    $ kubectl -n default patch redis s5 --type=merge --patch='{"spec": {"passwordSecret": "new-redis-password"}}'
    ```

    执行后，实例的状态将变为 `Initializing`。您可以通过以下命令查看状态：

    ```
    $ kubectl -n default get redis -w
    NAME ARCH       VERSION   ACCESS     STATUS         MESSAGE   BUNDLE VERSION   AUTOUPGRADE   AGE
    c6   cluster    6.0                  Ready                    4.0.1            false         125m
    s5   sentinel   5.0                  Initializing             4.0.1            false         8h
    s6   sentinel   6.0                  Ready                    4.0.1            false         124m
    ```
  </Tab>

  <Tab label="Web Console">
    1. 选择对应的用户信息，点击扩展按钮。
    2. 选择 **重置密码**，输入新密码，再次输入以确认。
    3. 等待更新完成即可。
  </Tab>
</Tabs>

## 更新权限

Web Console 提供以下预定义权限集：

| 权限集       | ACL 规则                                   | 描述                                                       |
|:-------------|:-------------------------------------------|:-----------------------------------------------------------|
| NotDangerous | +@all -@dangerous ~*                       | 允许对所有 KEYS 执行除 dangerous 类外的所有命令。         |
| ReadWrite    | -@all +@write +@read -@dangerous ~*       | 允许在所有 KEYS 上执行除 dangerous 类别外的所有读写命令。 |
| ReadOnly     | -@all +@read -keys ~*                      | 允许对所有 KEYS 执行所有读取类命令。                     |
| Administrator | +@all -acl ~*                             | 允许对所有 KEYS 执行所有命令。                           |

此外，还支持自定义规则。有关自定义规则的信息，请参见 Redis 社区文档中的 [ACL 规则](https://redis.io/topics/acl)。

> 重要的是，内置的 ACL 规则和自定义规则均会强制收回执行 ACL 命令的权限。用户的更改只能在此进行。

### 操作步骤

<Tabs>
  <Tab label="CLI">
    ```bash
    $ kubectl -n default patch RedisUser s56 --type=merge --patch='{"spec": {"aclRules": "+@all ~*"}}'
    ```

    成功创建后，该用户将随机进入 `Pending` 状态。等待其变为 `Success` 状态，即表示更新成功。
  </Tab>

  <Tab label="Web Console">
    1. 选择对应的用户信息，点击扩展按钮。
    2. 选择 **更新权限**。
    3. 选择权限集或点击自定义输入自定义规则。
    4. 点击 **更新**，等待更新完成。
  </Tab>
</Tabs>

## 创建用户

### 操作步骤

<Tabs>
  <Tab label="CLI">
    为 Redis 集群实例创建用户。

    ```bash
    $ cat << EOF | kubectl -n default create -f -
    apiVersion: redis.middleware.alauda.io/v1
    kind: RedisUser
    metadata:
      name: rfr-acl-s6-app-a
    spec:
      accountType: custom
      aclRules: +@all -acl ~*
      passwordSecrets:
      - new-redis-password
      redisName: s6
      username: app-a
    EOF

    一旦资源状态变为 `Success`，您可以使用新密码进行调试连接。
    ```
  </Tab>

  <Tab label="Web Console">
    1. 点击 **创建用户**。
    2. 输入用户名。
    3. 输入密码并重复输入以确认。
    4. 选择权限集或点击自定义输入自定义规则。
    5. 点击 **确认** 以创建用户。
    6. 选择用户，点击用户名可查看用户状态。

    一旦资源状态变为 **正常**，您可以使用新密码进行调试连接。
  </Tab>
</Tabs>
