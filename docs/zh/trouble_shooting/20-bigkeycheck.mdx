---
weight: 20
sourceSHA: 9919ad5dd438a40c47ead16b8696ef119c250acbd547dec0543211c256ae6016
---

# BigKey 的发现与处理

BigKey 的存在会对 Redis 服务的性能和稳定性造成影响，甚至会导致服务故障。该文档主要介绍了 BigKey 的概念、检测方法和处理方法。

## 什么是 BigKey

BigKey 并不是指 Key 本身很大，而是指与之关联的值很大。一般从值的内存占用大小和成员的数量来进行综合评估。例如：

- 字符串（String）：大小超过 5MB。
- 列表（List）：元素数量超过 20,000 个。
- 集合（Set）：元素数量超过 10,000 个。
- 有序集合（Sorted Set）：元素数量超过 10,000 个。
- 哈希表（Hash）：字段数量超过 10,000 个。

> 以上标准仅供参考。

## BigKey 的影响

BigKey 会对 Redis 服务的性能和稳定性造成影响，主要表现在以下几个方面：

- **阻塞线程**：由于 Redis 数据处理是单线程的，执行一个耗时的命令时，会阻塞其他命令的执行，导致 Redis 服务性能下降。
- **客户端超时**：由于 Redis 的单线程特性，在处理大 Key 时会花费较长时间，导致客户端无响应。
- **网络带宽占用**：BigKey 的传输占用了大量网络带宽，造成 Redis 服务的网络传输压力过大。例如，一个 Key 的大小为 1MB，每秒访问量达到 1000 次，结果将产生每秒 1000MB 的流量，这对于普通千兆网络接口的服务器来说是灾难性的。

特别是对于集群模式，可能会产生以下影响：

- **内存分布不均**：BigKey 可能导致集群中某个节点的内存消耗过大，而其他节点内存消耗较少，造成集群内存分布不均。
- **高数据迁移压力**：在集群模式扩缩容的过程中，迁移 BigKey 可能会长时间阻塞 Redis，影响正常业务访问，并降低集群稳定性，甚至可能导致服务故障。

## BigKey 的检测

### 使用巡检工具检测

Alauda 应用服务提供了 **巡检** 功能，使您能够检测 Redis 实例中的 BigKey。

1. 编辑巡检工具部署配置，以启用 BigKey 检测。

在实例所在的集群上，编辑 RdsInstaller 功能以启用 BigKey 检测。

```bash
# 首先检查 RdsInstaller 配置
$ kubectl -n rds-system get RdsInstaller rds -o yaml
```

输出如下：

```yaml
apiVersion: middleware.alauda.io/v1
kind: RdsInstaller
metadata:
  name: rds
spec:
  ......
  inspection:
    concurrency: "10"
    dependency: true
    env:
    - name: ENABLE_REDIS_KEYS_INDICATOR
    image: xxx
    imagePullPolicy: Always
    instanceReportLimit: "10"
    name: inspection-operator
    namespace: rds-system
    ......
```

2. 修改 `ENABLE_REDIS_KEYS_INDICATOR` 环境变量的值并保存。

```bash
$ kubectl -n rds-system edit RdsInstaller rds
```

将 `spec.inspection.env` 中的 `ENABLE_REDIS_KEYS_INDICATOR` 的值更改为 `1`。修改后的实例如下：

```yaml
apiVersion: middleware.alauda.io/v1
kind: RdsInstaller
metadata:
  name: rds
spec:
  ......
  inspection:
    concurrency: "10"
    dependency: true
    env:
    - name: ENABLE_REDIS_KEYS_INDICATOR
      value: "1"
    image: xxx
    imagePullPolicy: Always
    instanceReportLimit: "10"
    name: inspection-operator
    namespace: rds-system
    ......
```

保存之后，巡检工具将重启。您可以使用以下命令检查重启进度：

```bash
$ kubectl -n rds-system get pods -l name.operator=inspection-operator
```

输出如下：

```bash
$ kubectl -n rds-system get pods -l name.operator=inspection-operator
NAME                                   READY   STATUS    RESTARTS   AGE
inspection-operator-545468bd54-9g65p   1/1     Running   0          8s
```

> 注意：上述修改不是永久生效的，配置会在平台升级期间被覆盖。

3. 执行巡检

在 **Redis** -> **详情信息** 页面，点击 **巡检** 按钮以启动实例的巡检。

一旦巡检开始，按钮将显示 **巡检中...**，完成后巡检按钮将变为可点击状态。

> 由于激活了 BigKey 检测功能，巡检工具将 `SCAN` 缓存中所有数据，因此该过程可能需要相当长的时间。

4. 查看巡检结果

巡检完成后，您可以在 **Redis** -> **详情信息** 页面中的巡检报告点击 **查询** 按钮，以查看巡检结果。

![BigKey检测报告查看入口](../assets/44redis-bigkey-inspect-report-entry.png)

如果实例中确实存在 BigKey，巡检结果将列出 `BigKey Top5` 项目，如下图所示：

![BigKey检测报告](../assets/44redis-bigkey-inspect-report.png)

#### 使用限制

- 巡检工具会对 Redis 数据进行全库遍历，这将对 Redis 服务造成一定的压力，建议在业务低峰期使用。
- 目前，巡检工具只支持检测 `string`、`list` 和 `zset` 类型。

### 使用命令行检测

Redis 社区提供了使用 `redis-cli` 来检测 BigKey 的功能。在检测时，它会遍历/采样 Redis 实例中的所有 Key，并返回 Key 的总体统计信息以及每种数据类型中最大的 Key。bigkeys 目前支持分析 `string`、`list`、`set`、`zset`、`hash` 和 `stream` 类型。执行命令如下：

```bash
$ redis-cli -h <host> -a <password> --bigkeys
```

#### 使用限制

- `redis-cli` 检测也会对 Redis 数据进行全库遍历，会对 Redis 服务造成一定的压力，建议在业务低峰期使用。

## BigKey 的优化

需要根据具体的业务场景和数据特征选择合适的优化方案，通常可以从以下几个方面着手：

### 存储数据结构的优化

对于成员数量较多的集合类型（如 `list`、`set`、`zset` 和 `hash` 等），应将其拆分为多个 Key，并确保每个 Key 的成员数量在合理范围内。在 Redis 集群架构中，将大 Key 拆分可以显著提高数据分片之间的内存平衡。

### 对数据进行压缩

如果缓存了大量的 JSON 或 HTML 数据，可以考虑对这些数据进行压缩。此外，您还可以使用 ProtoBuffer 或 MessagePack 等序列化协议来减小数据大小。

### 定期清理过期数据

对于具有明确过期时间的数据，您可以通过设置过期时间来自动清理过期数据。对于过期时间不确定的数据，应定期对其进行清理。这尤其适用于 `list`、`set`、`zset` 和 `hash` 等数据结构，它们可能会积累大量的过期数据，因此建议结合使用 `SCAN` 和 `DEL` 来清除无效成员。

不论选择哪种优化方案，特别需要注意的是，在清理现有的 BigKey 时，需谨慎使用 `DEL` 命令，因为 `DEL` 命令会阻塞 Redis 服务。建议使用 `UNLINK` 命令，`UNLINK` 命令会异步删除 Key，不会阻塞 Redis 服务。
