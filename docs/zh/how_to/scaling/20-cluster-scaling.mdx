---
weight: 20
sourceSHA: 4ef101a89b9114dac3aacacca8fd54939159b34bae4d5f77c801f66f879a753c
---

# 集群模式分片变更

Redis 集群模式通过将数据分片分布在多个节点上，实现高可用性和可扩展性。在实际应用中，根据业务需求，Redis 集群可能需要增加分片或减少分片。该文档详细介绍了进行分片变更的前提条件、资源要求、服务访问策略及分片变更所需时间。

## 前提条件

Redis 集群分片变更前需要确保以下条件：

- 集群实例的状态必须为运行中。
- 需要确保扩缩容前后分片的内存资源充足。
- 需要确保在业务的低峰期进行操作，以避免对业务造成影响。
- 需要确认变更前后 Pods 所在节点的网络带宽充足，避免因为网络带宽不足导致分片变更失败。
- 需要确保基础设施的可靠性，防止因为服务器故障、电力故障等，导致数据丢失或分片丢失等故障。

## 资源要求

在进行分片变更时，需要确保集群实例的资源充足，以保证分片变更的成功。

内存相关概念定义如下：

| 名称         | 定义              | 说明           |
|:-------------|:------------------|:---------------|
| 数据内存     | Redis 中数据实际占用的内存 | 在 Redis 中，可使用 `info memory` 查看。因为 redis-server 在不断优化和清理数据，该值是不断变化的。 |
| 最大数据内存 | 所有 Redis 节点中，数据占用内存的最大值 | 在 Redis 中，可使用 `info memory` 查看。 |
| 最大运行内存 | 最大数据内存 / 0.8 | `0.8` 是 `maxmemory` 与实例内存规格的比值，`0.8` 为一个理想状态下的最大值。因为 `maxmemory` 内存包含的不仅仅有数据内存，还包括 buffer 内存等。因此在实际生产中，建议这个比值范围是 0.5-0.8；值越小，需要的实例规格越大，Redis 发生 OOM 的可能性就越小。 |
| 迁移数据内存 | 缩容后需要删除的所有分片的数据内存之和 | 在缩容时，需要将要删除的分片中的数据迁移到其他分片中，可能存在数据都迁移到某个分片的情况。 |

### 增加分片

内存规格计算公式：`实例规格大小 >= 最大运行内存`

在数据比较均衡时，该公式可保证增加分片的成功。如果**数据不均衡**或存在 BigKey，很可能存在数据都迁移到某个分片的情况，这个情况对资源的要求会很高；**因此没有做硬性限制，需要根据实际情况评估**。

### 减少分片

内存规格计算公式：`实例规格大小 >= (缩容后保留的分片中的最大数据内存 + 迁移数据内存) / 0.8`

在数据比较均衡时，该公式可保证减少分片的成功。如果**数据不均衡**或存在 BigKey，很可能存在数据都迁移到某个分片的情况；但是与增加分片不同，减少分片应该在一段时间内业务持续低负载，并且内存大量空闲的情况下进行，因此对不均衡的数据缩容的资源要求做了**硬性限制**。

## 操作步骤

<Tabs>
  <Tab label="CLI">
    分片变更即是增加或减少分片数量，可通过字段 `spec.replicas.cluster.shard` 来控制（具体参考 [API 文档](../../apis/kubernetes_apis/redis/redis)）

    ```bash
    # 设置集群的分片数为 4
    $ kubectl -n default patch redis c6 --type=merge --patch='{"spec": {"replicas":{"cluster":{"shard": 4}}}}'
    ```
  </Tab>

  <Tab label="Web Console">
    1. 在实例详情页面，点击 **分片变更**。

    2. 填入新的分片数，点击 **更新**。
  </Tab>
</Tabs>

提交分片变更后，系统会自动进行分片变更操作，变更过程中，实例状态会显示为 `数据平衡中`。该状态下，除了对实例**删除**之外，其他操作禁止执行。

## 分片变更过程中的服务访问策略

分片变更过程中，如果某个槽被标记为迁移中，且该槽下的 Key 正在被迁移，Redis 会返回 `MOVED` 错误，客户端需要重新发起请求。如果还未被迁移，仍将在原分片上处理。因此，客户端需要处理 `MOVED` 错误，并重新发起请求到新的分片。

> 注意：在业务高峰期进行分片变更可能导致客户端请求流量翻倍，从而造成网络带宽压力；因此，建议在业务低峰期进行分片变更。

## 分片变更所需时间

分片变更所需的时间取决于数据量大小、网络带宽、实例规格等多个因素。一般情况下，分片变更的时间在二十分钟到几个小时之间。数据越大，分片变更的时间越长。
