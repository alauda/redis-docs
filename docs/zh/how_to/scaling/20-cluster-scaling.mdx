---
weight: 20
sourceSHA: 4737393f2a1bc5c007dde9079b05e7b53dd3fca4817e6c38d140bb967d6af59e
---

# 集群模式分片扩展

Redis 集群架构通过将数据分布在多个分片上，提供了水平扩展性。随着工作负载需求的变化，您可能需要调整分片数量，以优化性能、资源利用和数据分布。本文档概述了分片扩展操作的技术考虑、资源要求和实施指南。

## 前提条件

在修改 Redis 集群的分片配置之前，请确保满足以下条件：

- **运行状态**：集群必须处于稳定的 `运行中` 状态，所有节点正常工作。
- **资源可用性**：集群中必须有足够的内存资源，以支持在扩展过程中进行数据重分布。
- **维护窗口**：在低流量期间安排扩展操作，以最小化对服务的潜在影响。
- **网络容量**：验证 Redis 节点之间有足够的网络带宽，以支持高效的数据迁移。
- **基础设施稳定性**：确保底层基础设施稳定，以防止扩展操作期间节点故障，可能会影响数据完整性。

## 资源要求

合理的资源规划对于成功的分片扩展操作至关重要。以下与内存相关的概念非常重要：

| 名称                   | 定义                                                 | 备注                                                                                                                                                                |
| :--------------------- | :--------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 数据内存               | Redis 数据集实际占用的内存                          | 通过 `info memory` 命令可观察到；该值会随着 Redis 进行内存优化和垃圾收集而波动                                                                                 |
| 最大数据内存           | 所有 Redis 节点中观察到的最高内存占用              | 可作为容量规划的参考点                                                                                                                                             |
| 最大运行内存           | 最大数据内存 ÷ 0.8                                   | 系数（0.8）代表了 `maxmemory` 与总实例内存分配之间的推荐比例；较低的比例会增加开销边际，但会降低内存效率                                                         |
| 迁移数据内存           | 被退役分片的数据总量                                 | 在缩容操作中，这些数据必须重新分配到剩余的分片                                                                                                                     |

### 扩展操作

当增加分片数量时，每个实例应满足：

```
实例内存分配 ≥ 最大运行内存
```

该公式确保在数据分布平衡的情况下成功添加分片。在具有**数据不平衡**或存在 BigKeys 的环境中，需要额外的容量规划，因为数据迁移模式可能会集中负载到特定的分片上。

### 缩减操作

当减少分片数量时，每个剩余实例应满足：

```
实例内存分配 ≥ (保留分片的最大数据内存 + 迁移数据内存) ÷ 0.8
```

该公式考虑了从被退役分片重新分配数据。与扩展操作不同，缩减过程对资源要求**严格**，以适应潜在的数据集中场景，即使在不平衡的数据分布中也是如此。

## 操作步骤

<Tabs>
  <Tab label="CLI">
    通过 Redis 自定义资源中的 `spec.replicas.cluster.shard` 字段来控制分片扩展操作（详细参数规格请参见 [API 文档](../../apis/kubernetes_apis/redis/redis)）。

    ```bash
    # 配置集群使用 4 个分片
    $ kubectl -n default patch redis c6 --type=merge --patch='{"spec": {"replicas":{"cluster":{"shard": 4}}}}'
    ```

    要监控扩展操作进度：

    ```bash
    $ kubectl -n default get redis c6 -w
    ```
  </Tab>

  <Tab label="Web 控制台">
    1. 导航到 **Redis** 实例详细信息页面。

    2. 在操作菜单中单击 **分片变更**。

    3. 输入所需的分片数量，然后单击 **更新** 以初始化扩展操作。
  </Tab>
</Tabs>

提交分片配置变更后，系统会将实例转换为 `数据平衡中` 状态，并自动管理插槽迁移过程。在此状态下，除了对实例进行**删除**操作外，禁止任何其他修改。

## 扩展期间的客户端连接

在进行分片重分配期间，Redis 插槽迁移对客户端请求处理的影响如下：

1. 当客户端请求访问某个标记为迁移的插槽中的键时：
   - 如果键已迁移到目标分片，Redis 将返回 `MOVED` 重定向错误
   - 如果键尚未迁移，则将由原分片处理

2. 支持 Redis 集群的客户端会自动处理这些重定向错误，通过重新发起请求到相应的分片

> **性能建议**：在高流量期间进行分片扩展可能会由于重定向将有效客户端请求量翻倍，可能会导致网络拥堵。因此，尽量在流量较低的时期安排扩展操作。

## 操作持续时间

完成分片扩展操作所需的时间取决于多个因素：

- 正在重新分配的总数据量
- 节点之间的网络吞吐量
- 实例资源规范
- 待迁移的 BigKeys 的存在
- 正在进行的工作负载强度

通常，分片扩展操作需要在 20 分钟到数小时之间完成。数据集越大，迁移模式越复杂，所需的时间会更长。
